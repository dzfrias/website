<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="My third update on the Ladybird WebAssembly implementation.">
    <meta name="author" content="Diego Frias">
    <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <title>Ladybird WebAssembly Update #2 - dzfrias</title>
    
<script type="module" src="/js/index.js"></script>
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f0f0f">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap">/* hebrew */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Ll4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0307-0308, U+0590-05FF, U+200C-2010, U+20AA, U+25CC, U+FB1D-FB4F;
}
/* latin-ext */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW77l4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Dl4brkiY8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>
  </head>
  <body>
    
<div aria-hidden="true" class="progress-bar"><div class="progress-bar-inner"></div></div>

    <div id="main-left">
      
<nav class="toc">
        <ol><li><a href="#improvements">Improvements</a><ol><li><a href="#floats">Floats</a><ol><li><a href="#the-fix">The Fix</a></li></ol></li><li><a href="#simd-bitwise-operations">SIMD Bitwise Operations</a></li></ol></li><li><a href="#expanding-the-goal">Expanding the Goal</a></li><li><a href="#wrap-up">Wrap-Up</a></li></ol>
      </nav>

    </div>
    <div id="main-content">
      <header>
        <nav>
          <a href="/" aria-label="Home">
            <div class="header-logo">
              <svg class="profile" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_2)">
<rect width="200" height="200" fill="#7B7B7B"></rect>
<path d="M-50 -50L245 245L-50 240.719V-50Z" fill="#040404"></path>
<path d="M98.45 34.8C106.25 34.2 110.1 33.9 110 33.9C110.9 33.9 111.5 34.25 111.8 34.95C111.9 35.35 108.3 50.25 101 79.65L89.6 125.25C89.4 127.55 89.4 129.4 89.6 130.8C89.8 131.3 90.1 131.7 90.5 132C90.8 132.3 91.25 132.45 91.85 132.45C92.55 132.45 93.1 132.35 93.5 132.15C95.4 130.75 97.35 126.2 99.35 118.5C99.85 116.6 100.25 115.55 100.55 115.35C100.75 115.15 101.95 115.05 104.15 115.05C106.35 115.05 107.6 115.15 107.9 115.35C108.1 115.55 108.2 115.95 108.2 116.55C108.2 117.15 107.95 118.35 107.45 120.15C103.75 132.75 98.5 139.25 91.7 139.65C86.6 139.95 82.5 138.2 79.4 134.4C78.9 133.8 78.45 133.15 78.05 132.45C77.85 131.85 77.7 131.55 77.6 131.55L76.55 132.45C73.05 135.55 69.6 137.6 66.2 138.6C59.7 140.8 53.85 139.8 48.65 135.6C48.05 135.1 47.5 134.55 47 133.95C45.5 132.45 44.25 130.65 43.25 128.55C40.75 123.45 39.95 117.4 40.85 110.4C42.45 99 47.3 89.4 55.4 81.6C60.6 76.6 66.25 73.45 72.35 72.15C73.25 71.95 74.65 71.85 76.55 71.85C79.05 71.85 81.2 72.25 83 73.05C84.4 73.75 85.7 74.7 86.9 75.9C87.7 76.7 88.1 77 88.1 76.8C88.2 76.7 89.45 71.9 91.85 62.4C94.15 53.1 95.35 47.9 95.45 46.8C95.45 45.9 95.35 45.35 95.15 45.15C94.45 44.45 92.3 44.05 88.7 43.95C86.3 43.95 84.9 43.6 84.5 42.9L84.35 42.45L85.1 39.45C85.5 37.55 85.9 36.4 86.3 36C86.6 35.7 86.9 35.55 87.2 35.55L98.45 34.8ZM77.15 78.9C73.05 78.2 69.1 80.15 65.3 84.75C64.3 86.05 63.4 87.45 62.6 88.95C61.1 91.85 59.3 97.55 57.2 106.05C55.9 110.85 54.95 115.05 54.35 118.65C53.95 122.05 53.95 124.65 54.35 126.45C55.35 129.95 57.3 131.95 60.2 132.45C61.9 132.75 63.95 132.4 66.35 131.4C69.95 129.4 73.35 126.05 76.55 121.35L77.3 120.3L81.05 105.3L84.8 90.3L84.5 89.25C83.6 83.55 81.4 80.15 77.9 79.05C77.7 78.95 77.45 78.9 77.15 78.9ZM154.811 32.4C155.311 32.3 156.311 32.25 157.811 32.25C160.111 32.35 162.211 32.9 164.111 33.9C168.011 35.9 169.961 39.1 169.961 43.5C169.961 45.3 169.561 47 168.761 48.6C168.361 49.6 167.761 50.45 166.961 51.15C165.961 52.15 165.111 52.8 164.411 53.1C161.611 54.4 158.961 54.45 156.461 53.25C153.961 51.95 153.061 49.65 153.761 46.35C153.861 45.95 153.961 45.55 154.061 45.15C154.761 42.85 156.011 41.15 157.811 40.05C158.311 39.75 157.961 39.5 156.761 39.3C156.061 39.3 155.561 39.4 155.261 39.6C154.461 40.2 153.911 40.9 153.611 41.7C153.211 42.5 152.161 47.1 150.461 55.5C148.161 66.5 147.011 72.4 147.011 73.2C147.011 73.3 149.711 73.35 155.111 73.35H163.211L163.811 73.8C164.211 74.3 164.161 75.65 163.661 77.85C163.161 80.05 162.711 81.25 162.311 81.45C162.011 81.65 159.111 81.75 153.611 81.75C148.111 81.75 145.361 81.85 145.361 82.05L141.461 101.85L136.961 125.1C134.261 138.1 131.661 147.4 129.161 153C125.961 160.4 121.861 165.25 116.861 167.55C115.461 168.25 113.961 168.65 112.361 168.75C107.961 168.95 104.461 167.6 101.861 164.7C101.661 164.6 101.511 164.45 101.411 164.25C100.011 162.25 99.3113 160.05 99.3113 157.65C99.3113 155.75 99.7113 154 100.511 152.4C100.911 151.4 101.511 150.55 102.311 149.85C103.311 148.85 104.161 148.2 104.861 147.9C107.661 146.6 110.311 146.55 112.811 147.75C115.311 149.05 116.211 151.35 115.511 154.65C115.411 155.05 115.311 155.45 115.211 155.85C114.511 158.15 113.261 159.85 111.461 160.95C110.861 161.35 111.211 161.55 112.511 161.55C113.311 161.55 113.911 161.4 114.311 161.1C115.611 160.1 116.611 157.5 117.311 153.3C118.311 147 119.811 139.9 121.811 132L124.811 118.5C129.511 93.4 131.861 81.2 131.861 81.9C131.861 81.8 129.561 81.75 124.961 81.75C120.061 81.75 117.411 81.4 117.011 80.7C116.811 80.4 116.961 79.25 117.461 77.25C117.961 75.25 118.361 74.1 118.661 73.8L119.111 73.35H126.311H133.511V73.05L135.011 65.7C137.011 55.3 138.961 48.05 140.861 43.95C143.961 37.65 148.611 33.8 154.811 32.4Z" fill="white"></path>
</g>
<defs>
<clipPath id="clip0_1_2">
<rect width="200" height="200" fill="white"></rect>
</clipPath>
</defs>
</svg>

            </div>
          </a>
          <ul>
            
            <li>
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
              <a href="/projects/">Projects</a>
            </li>
            
            <li>
              <a href="https://github.com/dzfrias">GitHub</a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main tabindex="-1">
        
<h1>Ladybird WebAssembly Update #2</h1>
<p>Nearly a month has passed since my
<a href="https://dzfrias.dev/blog/ladybird-wasm-1/">latest update</a> on the
<a href="https://webassembly.org/">WebAssembly</a> implementation of the
<a href="https://ladybird.org/">Ladybird browser</a>. My intention is to get the Wasm
virtual machine to be <strong>fully spec-compliant</strong> by the end of the summer. My
<a href="https://dzfrias.dev/blog/ladybird-wasm-1/">original post</a> explains a little bit
more about what that means as well as my motivations behind it.</p>
<p><em>A lot</em> has happened in the last few weeks, so I'll do my best to show my
progress in this post. I also have an exciting announcement to make regarding
the scope of this challenge!</p>
<h2 id="improvements" tabindex="-1"><a class="header-anchor" href="#improvements">Improvements</a></h2>
<p>Right now, we're sitting at a mere <strong>10 tests</strong> that do not pass on my
machine.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> Here's a list of the PRs I've made, from most to least recent:</p>
<ol>
<li>Fix a tiny <code>memory.grow</code> bug
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/563">see PR</a>)</li>
<li>Fix loop arity for certain blocktypes
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/559">see PR</a>)</li>
<li>Implement SIMD bitwise operations
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/558">see PR</a>)</li>
<li>Fully validate section lengths
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/522">see PR</a>)</li>
<li>Give names to functions exposed to JS via <code>ref.func</code>
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/521">see PR</a>)</li>
<li>Clean up some unused value type variants
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/500">see PR</a>)</li>
<li>Make float operations fully spec-compliant
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/459">see PR</a>)</li>
<li>Validate edge-case <code>if</code> instruction
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/418">see PR</a>)</li>
</ol>
<p>In the following subsections, I'll go into a little bit more detail about a few
of the notable PRs.</p>
<h3 id="floats" tabindex="-1"><a class="header-anchor" href="#floats">Floats</a></h3>
<p>This was a very, <em>very</em> painful thing to work on. The main problem was this:</p>
<p>In the <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE754 spec</a>, there are many
float bit patterns that mean &quot;not-a-number&quot;.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> However, most JS
implementations canonicalize them, meaning that two JS <code>NaN</code>s will <em>always</em> have
the same bit pattern, even though they <em>technically</em> could have different
internal representations and nobody would be mad.<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> For example,
<code>0x7fc00000</code> and <code>0x7fb71688</code> are both &quot;not-a-number&quot; by IEEE754's standard, but
JS <code>NaN</code>s are always the former.<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup></p>
<p>&quot;Wait we're talking about Wasm, so why is this a problem?&quot; Well, the Ladybird
Wasm testsuite <strong>uses JavaScript</strong> as a harness to run the tests! This means
that we sometimes need to pass <code>NaN</code>s from JS to Wasm. But sometimes, we want to
pass a <code>NaN</code> that <strong>is not</strong> <code>0x7fc00000</code>. There is literally no way to do that
in JS.</p>
<p>So, in short, because Ladybird's JS implementation canonicalizes <code>NaN</code>s to have
the same bit pattern, we lose vital information when passing arguments to Wasm
tests. Technically, this is not a problem with the Wasm VM itself. The VM is
pretty much fine. It's a problem with how the tests are run.</p>
<h4 id="the-fix" tabindex="-1"><a class="header-anchor" href="#the-fix">The Fix</a></h4>
<p>To fix this, instead of passing <code>NaN</code> from JavaScript (and losing information),
<strong>we now pass a <code>Uint8Array</code></strong> that contains the specific bit pattern of the
<code>NaN</code> in question. Then, when JS values are being translated to Wasm values, we
check if it's a <code>Uint8Array</code>, and if it is, we <code>memcpy</code> the data into a float
(we're in C++ land at that point, and C++ doesn't canonicalize anything).</p>
<p>This wasn't an easy problem to solve, nor was it to find! You can read the code
<a href="https://github.com/LadybirdBrowser/ladybird/blob/3850214aac1b84356d7f2ae1a4eb0079884ec2a9/Tests/LibWasm/test-wasm.cpp#L260">here</a>.</p>
<h3 id="simd-bitwise-operations" tabindex="-1"><a class="header-anchor" href="#simd-bitwise-operations">SIMD Bitwise Operations</a></h3>
<p>I saw that some SIMD instructions such as:</p>
<ul>
<li><code>v128.not</code></li>
<li><code>v128.and</code></li>
<li><code>v128.or</code></li>
<li>etc.</li>
</ul>
<p>weren't implemented, and they seemed like low-hanging fruit, since they're just
bitwise operations on a <code>u128</code>. I've been staying away from SIMD, but this was
<em>too hard</em> to just ignore! I implemented them in a few minutes and a bunch of
tests pass now.</p>
<p>This leads me into my next announcement...</p>
<h2 id="expanding-the-goal" tabindex="-1"><a class="header-anchor" href="#expanding-the-goal">Expanding the Goal</a></h2>
<p>We've reached nearly full spec-compliance (minus SIMD) <em>much faster</em> than I
thought we would.<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> I initially decided to ignore SIMD tests because very
few compilers take advantage of Wasm SIMD, even though it's part of the
specification. But, since we have the extra time, <strong>why not go for 100% for
real</strong>? The whole WebAssembly 2.0!</p>
<p>I did <a href="https://dzfrias.dev/blog/simd-backed-strings/">an experiment with SIMD</a> a
few weeks ago, and I feel comfortable enough to implement it.
<a href="https://github.com/Enverbalalic">Another Ladybird contributor</a> has been stuck
on <a href="https://github.com/LadybirdBrowser/ladybird/pull/159">a big SIMD PR</a> for a
while now, so I think the first thing to do is to start there!</p>
<h2 id="wrap-up" tabindex="-1"><a class="header-anchor" href="#wrap-up">Wrap-Up</a></h2>
<p>With a good amount of things just pushed to the to-do list, I once again invite
you to help out! We can <em>definitely</em> get to 100% by the end of the summer; the
existing progress has been a testament to that.</p>
<p>From a personal perspective, I've really enjoyed contributing to the project.
I've learned a lot of modern C++ (even a little bit of template magic!), and I
truly believe in the project's mission.</p>
<p>As always, if you have any issues, questions, or feedback about the post, feel
free to post an issue on
<a href="https://github.com/dzfrias/website/issues/new">this website's GitHub repo</a>!</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>This does not include SIMD tests, but you'll read more about that later :) <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>I'd recommend checking out <a href="https://float.exposed/0x7fc00000">float.exposed</a>
to play around with the number of <code>NaN</code>s there are! <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>This isn't fully true. Most JS implementations (including Ladybird's) do
something called
<a href="https://craftinginterpreters.com/optimization.html#nan-boxing">NaN boxing</a>,
which essentially exploit the idea that <code>NaN</code> bit patterns are arbitrary to
the effect of storing extra information inside <code>NaN</code> values. That's actually
the reason why <code>NaN</code>s are canonicalized in the first place (so there's &quot;one
true NaN&quot;)! <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>This canonicalization behavior is not part of the JS standard, but is common
among JS implementations. <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>We're only about halfway through the summer! <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>


      </main>
    </div>
    <div id="main-right">
      
      
    </div>
  </body>
</html>
