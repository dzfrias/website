<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="My fourth update on the Ladybird WebAssembly implementation.">
    <meta name="author" content="Diego Frias">
    <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <title>Ladybird WebAssembly Update #3 - dzfrias</title>
    

<script type="module">
  const e=document.getElementsByClassName("expand-img");for(let t of e){const e=t.children[0],n=t.children[1];e.addEventListener("click",(()=>n.showModal())),n.addEventListener("click",(e=>{const t=e.target.getBoundingClientRect();t.top<=e.clientY&&e.clientY<=t.top+t.height&&t.left<=e.clientX&&e.clientX<=t.left+t.width||n.close()}))}const t=new Map;!function e(n){for(const o of n.children)switch(o.tagName){case"OL":e(o);break;case"LI":const n=o.firstElementChild;t.set(n.href,n);for(let t=1;t<o.children.length;t++){e(o.children[t])}}}(document.getElementsByClassName("toc")[0].firstElementChild);const n=Array.from(document.getElementsByClassName("header-anchor"));n.sort(((e,t)=>e.getBoundingClientRect().y-t.getBoundingClientRect().y));let o=0,s=!1,i=null;document.addEventListener("scroll",(()=>{o=window.scrollY,s||(window.requestAnimationFrame((()=>{i&&(i.ariaCurrent="false");const e=Array.from(n).sort(((e,t)=>{const n=e.getBoundingClientRect().top,o=t.getBoundingClientRect().top;return Math.abs(n)-Math.abs(o)}))[0];t.get(e.href).ariaCurrent="location",i=t.get(e.href),s=!1})),s=!0)}));for(const e of document.getElementsByClassName("progress-bar")){const t=e.firstElementChild;document.addEventListener("scroll",(()=>{const e=window.scrollY/(document.body.offsetHeight-window.innerHeight);t.style.width=100*e+"%"}))}const l=document.querySelectorAll('a[id^="fnref"]'),r=document.getElementsByClassName("footnote-item"),c=document.getElementById("main-right");for(let e=0;e<l.length;e++){const t=l[e],n=r[e].children[0].cloneNode(!0);let o;t.addEventListener("mouseover",(()=>{o=document.createElement("aside"),c.appendChild(o),o.classList.add("footnote-preview"),o.appendChild(n),o.style.position="absolute",o.style.top=t.getBoundingClientRect().top+window.scrollY+"px",o.style.opacity="100%"})),t.addEventListener("mouseleave",(()=>{o.style.opacity="0%",o.addEventListener("transitionend",(()=>o.remove()))}))}function a(){const e=location.hash.slice(1);if(!e.startsWith("fn")||e.startsWith("fnref")){for(const e of r)e.ariaCurrent=null;return}for(const e of r)e.ariaCurrent="false";document.getElementById(e).ariaCurrent="true"}a(),window.onhashchange=a;
</script>
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"></noscript>

    <link rel="stylesheet" href="/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f0f0f">
    <link rel="preload" href="/fonts/font.woff2" as="font" type="font/woff2" crossorigin="">
    <meta name="theme-color" content="#0f0f0f">
  </head>
  <body>
    
<div aria-hidden="true" class="progress-bar"><div class="progress-bar-inner"></div></div>

    <div id="main-left">
      
<aside class="toc-container">
  <nav class="toc">
        <ol><li><a href="#improvements">Improvements</a><ol><li><a href="#inxm-pr-co-author">iNxM PR Co-Author</a></li><li><a href="#gcc-weirdness">gcc Weirdness</a></li><li><a href="#optimizations">Optimizations</a></li></ol></li><li><a href="#going-forward">Going Forward</a></li></ol>
      </nav>
</aside>

    </div>
    <div id="main-content">
      <header>
        <nav>
          <a href="/" aria-label="Home">
            <div class="header-logo">
              <svg class="profile" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_2)">
<rect width="200" height="200" fill="#7B7B7B"></rect>
<path d="M-50 -50L245 245L-50 240.719V-50Z" fill="#040404"></path>
<path d="M98.45 34.8C106.25 34.2 110.1 33.9 110 33.9C110.9 33.9 111.5 34.25 111.8 34.95C111.9 35.35 108.3 50.25 101 79.65L89.6 125.25C89.4 127.55 89.4 129.4 89.6 130.8C89.8 131.3 90.1 131.7 90.5 132C90.8 132.3 91.25 132.45 91.85 132.45C92.55 132.45 93.1 132.35 93.5 132.15C95.4 130.75 97.35 126.2 99.35 118.5C99.85 116.6 100.25 115.55 100.55 115.35C100.75 115.15 101.95 115.05 104.15 115.05C106.35 115.05 107.6 115.15 107.9 115.35C108.1 115.55 108.2 115.95 108.2 116.55C108.2 117.15 107.95 118.35 107.45 120.15C103.75 132.75 98.5 139.25 91.7 139.65C86.6 139.95 82.5 138.2 79.4 134.4C78.9 133.8 78.45 133.15 78.05 132.45C77.85 131.85 77.7 131.55 77.6 131.55L76.55 132.45C73.05 135.55 69.6 137.6 66.2 138.6C59.7 140.8 53.85 139.8 48.65 135.6C48.05 135.1 47.5 134.55 47 133.95C45.5 132.45 44.25 130.65 43.25 128.55C40.75 123.45 39.95 117.4 40.85 110.4C42.45 99 47.3 89.4 55.4 81.6C60.6 76.6 66.25 73.45 72.35 72.15C73.25 71.95 74.65 71.85 76.55 71.85C79.05 71.85 81.2 72.25 83 73.05C84.4 73.75 85.7 74.7 86.9 75.9C87.7 76.7 88.1 77 88.1 76.8C88.2 76.7 89.45 71.9 91.85 62.4C94.15 53.1 95.35 47.9 95.45 46.8C95.45 45.9 95.35 45.35 95.15 45.15C94.45 44.45 92.3 44.05 88.7 43.95C86.3 43.95 84.9 43.6 84.5 42.9L84.35 42.45L85.1 39.45C85.5 37.55 85.9 36.4 86.3 36C86.6 35.7 86.9 35.55 87.2 35.55L98.45 34.8ZM77.15 78.9C73.05 78.2 69.1 80.15 65.3 84.75C64.3 86.05 63.4 87.45 62.6 88.95C61.1 91.85 59.3 97.55 57.2 106.05C55.9 110.85 54.95 115.05 54.35 118.65C53.95 122.05 53.95 124.65 54.35 126.45C55.35 129.95 57.3 131.95 60.2 132.45C61.9 132.75 63.95 132.4 66.35 131.4C69.95 129.4 73.35 126.05 76.55 121.35L77.3 120.3L81.05 105.3L84.8 90.3L84.5 89.25C83.6 83.55 81.4 80.15 77.9 79.05C77.7 78.95 77.45 78.9 77.15 78.9ZM154.811 32.4C155.311 32.3 156.311 32.25 157.811 32.25C160.111 32.35 162.211 32.9 164.111 33.9C168.011 35.9 169.961 39.1 169.961 43.5C169.961 45.3 169.561 47 168.761 48.6C168.361 49.6 167.761 50.45 166.961 51.15C165.961 52.15 165.111 52.8 164.411 53.1C161.611 54.4 158.961 54.45 156.461 53.25C153.961 51.95 153.061 49.65 153.761 46.35C153.861 45.95 153.961 45.55 154.061 45.15C154.761 42.85 156.011 41.15 157.811 40.05C158.311 39.75 157.961 39.5 156.761 39.3C156.061 39.3 155.561 39.4 155.261 39.6C154.461 40.2 153.911 40.9 153.611 41.7C153.211 42.5 152.161 47.1 150.461 55.5C148.161 66.5 147.011 72.4 147.011 73.2C147.011 73.3 149.711 73.35 155.111 73.35H163.211L163.811 73.8C164.211 74.3 164.161 75.65 163.661 77.85C163.161 80.05 162.711 81.25 162.311 81.45C162.011 81.65 159.111 81.75 153.611 81.75C148.111 81.75 145.361 81.85 145.361 82.05L141.461 101.85L136.961 125.1C134.261 138.1 131.661 147.4 129.161 153C125.961 160.4 121.861 165.25 116.861 167.55C115.461 168.25 113.961 168.65 112.361 168.75C107.961 168.95 104.461 167.6 101.861 164.7C101.661 164.6 101.511 164.45 101.411 164.25C100.011 162.25 99.3113 160.05 99.3113 157.65C99.3113 155.75 99.7113 154 100.511 152.4C100.911 151.4 101.511 150.55 102.311 149.85C103.311 148.85 104.161 148.2 104.861 147.9C107.661 146.6 110.311 146.55 112.811 147.75C115.311 149.05 116.211 151.35 115.511 154.65C115.411 155.05 115.311 155.45 115.211 155.85C114.511 158.15 113.261 159.85 111.461 160.95C110.861 161.35 111.211 161.55 112.511 161.55C113.311 161.55 113.911 161.4 114.311 161.1C115.611 160.1 116.611 157.5 117.311 153.3C118.311 147 119.811 139.9 121.811 132L124.811 118.5C129.511 93.4 131.861 81.2 131.861 81.9C131.861 81.8 129.561 81.75 124.961 81.75C120.061 81.75 117.411 81.4 117.011 80.7C116.811 80.4 116.961 79.25 117.461 77.25C117.961 75.25 118.361 74.1 118.661 73.8L119.111 73.35H126.311H133.511V73.05L135.011 65.7C137.011 55.3 138.961 48.05 140.861 43.95C143.961 37.65 148.611 33.8 154.811 32.4Z" fill="white"></path>
</g>
<defs>
<clipPath id="clip0_1_2">
<rect width="200" height="200" fill="white"></rect>
</clipPath>
</defs>
</svg>

            </div>
          </a>
          <ul>
            
            <li>
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
              <a href="/projects/">Projects</a>
            </li>
            
            <li>
              <a href="https://github.com/dzfrias">GitHub</a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main tabindex="-1">
        
<h1>Ladybird WebAssembly Update #3</h1>
<p>It's been a great few weeks since
<a href="https://dzfrias.dev/blog/ladybird-wasm-2/">my last Ladybird browser update</a>,
where I'm focusing on the <a href="https://webassembly.org/">WebAssembly</a>
implementation, <strong>LibWasm</strong>. A few months ago, I set a goal: get LibWasm to pass
<em>the entire</em> Wasm 2.0 specification test suite by the end of the
summer.<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn1" id="fnref1">1</a></sup></p>
<p>I'm happy to announce that <strong>we've done it!</strong> As of
<a href="https://github.com/LadybirdBrowser/ladybird/pull/851/">PR #851</a>, there are zero
failing Wasm spec-tests.</p>
<p></p><div class="expand-img"><button aria-haspopup="dialog" aria-label="Expand image"><picture><source type="image/webp" srcset="/img/u56c6-1A1f-2588.webp 2588w"><img loading="lazy" decoding="async" src="/img/u56c6-1A1f-2588.jpeg" alt="A graph showing spec-test results over time" width="2588" height="1568"></picture></button><dialog><picture><source type="image/webp" srcset="/img/u56c6-1A1f-2588.webp 2588w"><img loading="lazy" decoding="async" src="/img/u56c6-1A1f-2588.jpeg" alt="A graph showing spec-test results over time" width="2588" height="1568"></picture></dialog></div><p></p>
<p>It's been an amazing journey, and I'll go over the specific progress we made in
this post!</p>
<h2 id="improvements" tabindex="-1"><a class="header-anchor" href="#improvements">Improvements</a></h2>
<p>A lot of my effort these past weeks has been directed towards
<a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a>, or
rather,
<a href="https://github.com/WebAssembly/simd/blob/main/proposals/simd/SIMD.md">WebAssembly's version of SIMD</a>.</p>
<p>I implemented/fixed the many of the Wasm SIMD instructions, including:</p>
<ul>
<li>Load and store (<a href="https://github.com/LadybirdBrowser/ladybird/pull/635">PR</a>)</li>
<li>Min/max (<a href="https://github.com/LadybirdBrowser/ladybird/pull/605">PR</a>)</li>
<li>Comparisons (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo></mrow><annotation encoding="application/x-tex">\lt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.5391em;"></span><span class="strut bottom" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mrel">&lt;</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≥</mo></mrow><annotation encoding="application/x-tex">\ge</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.63597em;"></span><span class="strut bottom" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="base textstyle uncramped"><span class="mrel">≥</span></span></span></span>, etc.)
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/594">PR</a>)</li>
<li>Integer conversions
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/719/commits/400dabf50d4f76d32455e5a83a6ba7d6dee9a292">PR</a>)</li>
<li>Float conversions
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/719/commits/a1d55875af3a365ce0eaf8f779d902d4323d6e70">PR</a>)</li>
<li>Bit shift right
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/794/commits/108065fe6f7755763163c66ebd485114bc4608a1">PR</a>)</li>
<li>Shuffle and swizzle<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn2" id="fnref2">2</a></sup>
(<a href="https://github.com/LadybirdBrowser/ladybird/pull/794/commits/b75a75350b32e2ec6f659abd9b7b3701a4f40ace">PR</a>)</li>
<li>A bunch more miscellaneous ones</li>
</ul>
<h3 id="inxm-pr-co-author" tabindex="-1"><a class="header-anchor" href="#inxm-pr-co-author">iNxM PR Co-Author</a></h3>
<p>I co-authored <a href="https://github.com/LadybirdBrowser/ladybird/pull/615">a large PR</a>
that implemented the vast majority of the SIMD integer operations. The
<a href="https://github.com/LadybirdBrowser/ladybird/pull/159">original PR</a> was written
by <a href="https://github.com/Enverbalalic">Enver Balalic</a>, but the author ran into
some annoying issues caught by UBSan, which I decided to try to help fix after a
few weeks.</p>
<p>It felt fantastic to check out someone's in-progress work and help out! Somewhat
anticlimactically, the undefined behavior was caused by C++'s implicit integer
conversions, which I've become more and more annoyed by over time...</p>
<h3 id="gcc-weirdness" tabindex="-1"><a class="header-anchor" href="#gcc-weirdness">gcc Weirdness</a></h3>
<p>Getting the Wasm SIMD testsuite to pass uniformly across macOS, Linux, clang,
and gcc was quite a chore. One such issue arose when implementing the swizzle
instructions.</p>
<p>Essentially, gcc has access to an
<a href="https://en.wikipedia.org/wiki/Intrinsic_function">intrinsic</a> called
<code>__builtin_shuffle</code>. Our goal is to use this intrinsic for our SIMD swizzle
instructions. However, <code>__builtin_shuffle</code> and Wasm's swizzle actually have
<strong>different behavior in edge-cases</strong>!</p>
<p>A swizzle in Wasm <em>should</em> look like this:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span>i8x16.swizzle
  <span class="token punctuation">(</span>v128.const i8x16 <span class="token number">10</span> <span class="token number">241</span> <span class="token number">-3</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">-15</span> <span class="token number">3</span> <span class="token number">23</span> <span class="token number">24</span> <span class="token number">25</span> <span class="token number">90</span> <span class="token number">244</span> <span class="token number">180</span> <span class="token number">4</span> <span class="token number">77</span> <span class="token number">31</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>v128.const i8x16 <span class="token number">15</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span> <span class="token number">11</span> <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; This will return a vector with the first (index 0) and last (index 15)</span>
<span class="token comment">;; elements swapped!</span>
<span class="token comment">;; (v128.const i8x16 31 241 -3 0 1 -15 3 23 24 25 90 244 180 4 77 10)</span></code></pre>
<p>When index vector has indices that are out of bounds, (i.e. -10 or 18), Wasm
says to put a 0 in the output vector, like so:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="token punctuation">(</span>i8x16.swizzle
  <span class="token punctuation">(</span>v128.const i8x16 <span class="token number">10</span> <span class="token number">241</span> <span class="token number">-3</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">-15</span> <span class="token number">3</span> <span class="token number">23</span> <span class="token number">24</span> <span class="token number">25</span> <span class="token number">90</span> <span class="token number">244</span> <span class="token number">180</span> <span class="token number">4</span> <span class="token number">77</span> <span class="token number">31</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>v128.const i8x16 <span class="token number">-10</span> <span class="token number">16</span> <span class="token number">100</span> <span class="token number">-1</span> <span class="token number">87</span> <span class="token number">99</span> <span class="token number">18</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">-1</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; All zeroes except for the last element:</span>
<span class="token comment">;; (v128.const i8x16 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 31)</span></code></pre>
<p>How does <code>__builtin_shuffle</code> work? It wraps those invalid indices modulo 16 and
proceeds from there, which is very different behavior!</p>
<p>Since I'm on macOS, clang is an unescapable default,<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn3" id="fnref3">3</a></sup> and clang
<strong>doesn't</strong> have the <code>__builtin_shuffle</code> intrinsic! I tried to compile Ladybird
using gcc, but ran into a ton of problems, so fixing this was a little
difficult.</p>
<p>The fix wasn't too difficult itself, but actually getting gcc working <em>was</em>.</p>
<h3 id="optimizations" tabindex="-1"><a class="header-anchor" href="#optimizations">Optimizations</a></h3>
<p>I optimized the parser quite a bit, making it fast enough to instantiate
<code>spidermonkey.wasm</code> (a 5.4mb file) in 140ms, compared to the initial 450ms.</p>
<p>I'm going to write a dedicated post about this in the future, so stay tuned for
that!</p>
<h2 id="going-forward" tabindex="-1"><a class="header-anchor" href="#going-forward">Going Forward</a></h2>
<p>It's taken a good amount of work to the point of full spec-compliance, which was
made possible by <a href="https://github.com/alimpfard">Ali</a>, who maintains LibWasm and
gave feedback on a lot of my PRs. But, even though my goal has been completed,
I'm <em>nowhere</em> near done hacking on Ladybird!</p>
<p>Right now, complex Wasm websites are nearly unusable because of how slow the
bytecode interpreter is. In the next few weeks, I think I'll focus my efforts on
that front!<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn4" id="fnref4">4</a></sup></p>
<p>Also, I've recently been branching out a little bit into other areas of the
browser. I implemented the <code>:has()</code> pseudo-class in
<a href="https://github.com/LadybirdBrowser/ladybird/pull/613">this PR</a>. More of that
work is to come!</p>
<hr>
<section class="footnotes" role="doc-endnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>You can read my <a href="https://dzfrias.dev/blog/ladybird-wasm-0/">original post</a>
for more details! <a role="doc-backlink" aria-label="back to text" href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>Fun fact: both shuffle <em>and</em> swizzle instructions re-order the lanes of a
vector based on a set of indices. The difference is that a shuffle's indices
are statically defined! <a role="doc-backlink" aria-label="back to text" href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>The <code>gcc</code> command on macOS is actually just a symlink to <code>clang</code>... <a role="doc-backlink" aria-label="back to text" href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>My <a href="https://dzfrias.github.io/romberg/">integral calculator website</a> does
work, though! <a role="doc-backlink" aria-label="back to text" href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
</ol></section>

      </main>
    </div>
    <div id="main-right">
      
      
    </div>
  </body>
</html>
