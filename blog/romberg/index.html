<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="An overview of a small project: a fast definite integral calculator.">
    <meta name="author" content="Diego Frias">
    <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <title>Side project: Fast definite integral calculator - dzfrias</title>
    
<script type="module" src="/js/index.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f0f0f">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap">/* hebrew */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Ll4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0307-0308, U+0590-05FF, U+200C-2010, U+20AA, U+25CC, U+FB1D-FB4F;
}
/* latin-ext */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW77l4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Dl4brkiY8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>
  </head>
  <body>
    
<div aria-hidden="true" class="progress-bar"><div class="progress-bar-inner"></div></div>

    <div id="main-left">
      
<nav class="toc">
        <ol><li><a href="#stuff-i-learned">Stuff I Learned</a><ol><li><a href="#wasm-rust-bindings">Wasm-Rust Bindings</a><ol><li><a href="#the-tooling-issue">The Tooling Issue</a></li></ol></li><li><a href="#rust-idioms-to-javascript">Rust Idioms to JavaScript</a></li></ol></li><li><a href="#wrap-up">Wrap Up</a></li></ol>
      </nav>

    </div>
    <div id="main-content">
      <header>
        <nav>
          <a href="/" aria-label="Home">
            <div class="header-logo">
              <svg class="profile" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_2)">
<rect width="200" height="200" fill="#7B7B7B"></rect>
<path d="M-50 -50L245 245L-50 240.719V-50Z" fill="#040404"></path>
<path d="M98.45 34.8C106.25 34.2 110.1 33.9 110 33.9C110.9 33.9 111.5 34.25 111.8 34.95C111.9 35.35 108.3 50.25 101 79.65L89.6 125.25C89.4 127.55 89.4 129.4 89.6 130.8C89.8 131.3 90.1 131.7 90.5 132C90.8 132.3 91.25 132.45 91.85 132.45C92.55 132.45 93.1 132.35 93.5 132.15C95.4 130.75 97.35 126.2 99.35 118.5C99.85 116.6 100.25 115.55 100.55 115.35C100.75 115.15 101.95 115.05 104.15 115.05C106.35 115.05 107.6 115.15 107.9 115.35C108.1 115.55 108.2 115.95 108.2 116.55C108.2 117.15 107.95 118.35 107.45 120.15C103.75 132.75 98.5 139.25 91.7 139.65C86.6 139.95 82.5 138.2 79.4 134.4C78.9 133.8 78.45 133.15 78.05 132.45C77.85 131.85 77.7 131.55 77.6 131.55L76.55 132.45C73.05 135.55 69.6 137.6 66.2 138.6C59.7 140.8 53.85 139.8 48.65 135.6C48.05 135.1 47.5 134.55 47 133.95C45.5 132.45 44.25 130.65 43.25 128.55C40.75 123.45 39.95 117.4 40.85 110.4C42.45 99 47.3 89.4 55.4 81.6C60.6 76.6 66.25 73.45 72.35 72.15C73.25 71.95 74.65 71.85 76.55 71.85C79.05 71.85 81.2 72.25 83 73.05C84.4 73.75 85.7 74.7 86.9 75.9C87.7 76.7 88.1 77 88.1 76.8C88.2 76.7 89.45 71.9 91.85 62.4C94.15 53.1 95.35 47.9 95.45 46.8C95.45 45.9 95.35 45.35 95.15 45.15C94.45 44.45 92.3 44.05 88.7 43.95C86.3 43.95 84.9 43.6 84.5 42.9L84.35 42.45L85.1 39.45C85.5 37.55 85.9 36.4 86.3 36C86.6 35.7 86.9 35.55 87.2 35.55L98.45 34.8ZM77.15 78.9C73.05 78.2 69.1 80.15 65.3 84.75C64.3 86.05 63.4 87.45 62.6 88.95C61.1 91.85 59.3 97.55 57.2 106.05C55.9 110.85 54.95 115.05 54.35 118.65C53.95 122.05 53.95 124.65 54.35 126.45C55.35 129.95 57.3 131.95 60.2 132.45C61.9 132.75 63.95 132.4 66.35 131.4C69.95 129.4 73.35 126.05 76.55 121.35L77.3 120.3L81.05 105.3L84.8 90.3L84.5 89.25C83.6 83.55 81.4 80.15 77.9 79.05C77.7 78.95 77.45 78.9 77.15 78.9ZM154.811 32.4C155.311 32.3 156.311 32.25 157.811 32.25C160.111 32.35 162.211 32.9 164.111 33.9C168.011 35.9 169.961 39.1 169.961 43.5C169.961 45.3 169.561 47 168.761 48.6C168.361 49.6 167.761 50.45 166.961 51.15C165.961 52.15 165.111 52.8 164.411 53.1C161.611 54.4 158.961 54.45 156.461 53.25C153.961 51.95 153.061 49.65 153.761 46.35C153.861 45.95 153.961 45.55 154.061 45.15C154.761 42.85 156.011 41.15 157.811 40.05C158.311 39.75 157.961 39.5 156.761 39.3C156.061 39.3 155.561 39.4 155.261 39.6C154.461 40.2 153.911 40.9 153.611 41.7C153.211 42.5 152.161 47.1 150.461 55.5C148.161 66.5 147.011 72.4 147.011 73.2C147.011 73.3 149.711 73.35 155.111 73.35H163.211L163.811 73.8C164.211 74.3 164.161 75.65 163.661 77.85C163.161 80.05 162.711 81.25 162.311 81.45C162.011 81.65 159.111 81.75 153.611 81.75C148.111 81.75 145.361 81.85 145.361 82.05L141.461 101.85L136.961 125.1C134.261 138.1 131.661 147.4 129.161 153C125.961 160.4 121.861 165.25 116.861 167.55C115.461 168.25 113.961 168.65 112.361 168.75C107.961 168.95 104.461 167.6 101.861 164.7C101.661 164.6 101.511 164.45 101.411 164.25C100.011 162.25 99.3113 160.05 99.3113 157.65C99.3113 155.75 99.7113 154 100.511 152.4C100.911 151.4 101.511 150.55 102.311 149.85C103.311 148.85 104.161 148.2 104.861 147.9C107.661 146.6 110.311 146.55 112.811 147.75C115.311 149.05 116.211 151.35 115.511 154.65C115.411 155.05 115.311 155.45 115.211 155.85C114.511 158.15 113.261 159.85 111.461 160.95C110.861 161.35 111.211 161.55 112.511 161.55C113.311 161.55 113.911 161.4 114.311 161.1C115.611 160.1 116.611 157.5 117.311 153.3C118.311 147 119.811 139.9 121.811 132L124.811 118.5C129.511 93.4 131.861 81.2 131.861 81.9C131.861 81.8 129.561 81.75 124.961 81.75C120.061 81.75 117.411 81.4 117.011 80.7C116.811 80.4 116.961 79.25 117.461 77.25C117.961 75.25 118.361 74.1 118.661 73.8L119.111 73.35H126.311H133.511V73.05L135.011 65.7C137.011 55.3 138.961 48.05 140.861 43.95C143.961 37.65 148.611 33.8 154.811 32.4Z" fill="white"></path>
</g>
<defs>
<clipPath id="clip0_1_2">
<rect width="200" height="200" fill="white"></rect>
</clipPath>
</defs>
</svg>

            </div>
          </a>
          <ul>
            
            <li>
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
              <a href="/projects/">Projects</a>
            </li>
            
            <li>
              <a href="https://github.com/dzfrias">GitHub</a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main tabindex="-1">
        
<h1>Side project: Fast definite integral calculator</h1>
<p>Recently, I built a <a href="https://en.wikipedia.org/wiki/Integral">definite integral</a>
calculator to supplement a project for a calculus class that I'm taking. In the
project, I researched
<a href="https://en.wikipedia.org/wiki/Romberg's_method">Romberg integration</a>, which is
a way to approximate definite integrals with just a few calculations.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> Along
with a <a href="https://github.com/dzfrias/romberg/blob/main/paper.pdf">paper</a>
documenting my research, I also made a
<a href="https://dzfrias.github.io/romberg/">website</a> that implements the algorithm
defined in my paper.</p>
<p>The website was fun to make! In order to get the best performance possible, I
wrote the core algorithm in <strong>Rust</strong> and compiled it to
<a href="https://webassembly.org/">WebAssembly</a>. The calculator can quickly determine
when the integral of a function over an interval does not converge,<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> and is
able to get extremely accurate approximations in just a few milliseconds.</p>
<p>By comparison to other online calculators, the one that I wrote is faster, just
as accurate, and importantly, <strong>reports when the integral does not converge</strong>.
In this blog post, I'll go over some things I learned in the process of making
the website!</p>
<h2 id="stuff-i-learned" tabindex="-1"><a class="header-anchor" href="#stuff-i-learned">Stuff I Learned</a></h2>
<p>Here are the main things I learned while making the website:</p>
<ol>
<li>Wasm-Rust bindings are great, but the amount of tooling is cumbersome</li>
<li>Rust idioms don't always translate well to JavaScript</li>
</ol>
<p>I'll go over these points in detail in the following subsections.</p>
<h3 id="wasm-rust-bindings" tabindex="-1"><a class="header-anchor" href="#wasm-rust-bindings">Wasm-Rust Bindings</a></h3>
<p>The <a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a> project makes
communicating between Rust and WebAssembly a breeze. It also makes using Web
APIs a super easy! Even if the functions that I want to export to WebAssembly
are complex, <code>wasm-bindgen</code> pretty much always has an <em>intuitive solution</em>
waiting for me.</p>
<p>Say I want to export this function in my compiled Wasm module:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">fun_format</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{s} is so cool!"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<p>If you've done any FFI work, you most likely just had flashbacks to late-night
FFI rabbit holes, complicated build steps, and the most &quot;are you kidding me&quot;
bugs possible. Sidestepping all of that, <code>wasm-bindgen</code> allows me to do this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">fun_format</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{s} is so cool!"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<p>And I'm done (at least from the Rust side). The JavaScript side is about as
easy. I cannot explain in words how satisfying it feels to put <code>#[wasm_bindgen]</code>
over a <code>struct</code>, <code>enum</code>, or function and just have it <strong>work</strong>. I know a good
amount about WebAssembly (the instruction set), and it still feels magical.</p>
<h4 id="the-tooling-issue" tabindex="-1"><a class="header-anchor" href="#the-tooling-issue">The Tooling Issue</a></h4>
<p>Unfortunately, even with such fantastic FFI, there's quite a bit of work you
have to do to get Rust running on the browser with libraries like
<code>wasm-bindgen</code>. There are three separate
<a href="https://github.com/rust-lang/mdBook">mdbooks</a> that I was bouncing between while
figuring out the website:</p>
<ol>
<li><a href="https://rustwasm.github.io/docs/book/">The <code>wasm-bingen</code> in-depth tutorial</a></li>
<li><a href="https://rustwasm.github.io/wasm-bindgen/introduction.html">The <code>wasm-bindgen</code> reference</a></li>
<li><a href="https://rustwasm.github.io/docs/wasm-pack/introduction.html">The <code>wasm-pack</code> book</a></li>
</ol>
<p><code>wasm-bindgen</code>, of course, is the library I mentioned earlier. <code>wasm-pack</code> is
the recommended tool for building your <code>wasm-bindgen</code> project (it's essentially
a wrapper over <code>cargo build</code>). There are a selection of targets to build for:
module bundlers like webpack (the default), node, and the browser.</p>
<p>All of this is pretty overwhelming when all I want to do is take advantage of
<code>wasm-bindgen</code>. I understand that an extra build step is pretty much required,
but I think <code>wasm-pack</code> has defaults that do not reflect the bare minimum of
work to get Rust code on the browser. The defaults should be simple: a Wasm
binary and some JavaScript files to load. No more, no less. The tutorials should
show you how to <em>build around</em> those compilation artifacts to take advantage of
more complex tools, like bundlers.</p>
<p>To make it worse, while I was working on getting my code on the browser, I was
getting deprecation warnings and incompatibility errors from the various
dependencies that this build process requires. As we all know, web tooling is a
very fast-growing space, and there were a ton of dependencies required by using
<code>wasm-pack</code>, many of which were outdated.</p>
<h3 id="rust-idioms-to-javascript" tabindex="-1"><a class="header-anchor" href="#rust-idioms-to-javascript">Rust Idioms to JavaScript</a></h3>
<p>This point is less of an annoyance and more of just an interesting problem I
encountered. I'll start with the actual issue:</p>
<p>We all know and love Rust's <code>Result&lt;T, E&gt;</code> type.<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> However, the
errors-as-values idea (and even enums in general) don't translate well to
JavaScript. In my program, the error type is defined as follows:</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">EvalError</span> <span class="token punctuation">{</span>
    <span class="token class-name">ParseError</span><span class="token punctuation">,</span>
    <span class="token class-name">DoesNotConverge</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token type-definition class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>result<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">EvalError</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// Example function</span>
<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">do_some_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span></code></pre>
<p>If I call <code>do_some_stuff</code> from JavaScript, and it returns a <code>Result::Err</code>, an
exception containing my <code>EvalError</code> will be thrown. This is a <em>completely</em>
different method for error handling! Interestingly, it's neither idiomatic Rust
<em>nor</em> idiomatic JavaScript. If I want to catch this error, then I will have to
do something like this:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"parsing error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"DNE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"bad error type found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><code>e</code> is a number because <code>EvalError</code> is translated to a number across the FFI
boundary. Not great...</p>
<h2 id="wrap-up" tabindex="-1"><a class="header-anchor" href="#wrap-up">Wrap Up</a></h2>
<p>To summarize my thoughts about the whole Rust-Wasm experience, I'd say that
<strong>allowing for nice APIs that work in complete generality is hard</strong>. Wasm is
useful (in part) <em>because</em> of its generality. That makes it hard to provide a
great FFI experience out of the box. Not to mention, a lot of the idioms of a
language are lost in translation.</p>
<p>This project was really fun and a small dip into the waters of the practical
uses of WebAssembly. There's a lot of theory and cool experiments being done all
the time in the Wasm community, including
<a href="https://github.com/dzfrias/wsh">one of my own projects</a>. So it's nice to check
in with the real world once in a while. Not to mention, it was fun mixing
together heavy math and programming!</p>
<p>You can read <a href="https://github.com/dzfrias/romberg/blob/main/paper.pdf">the paper</a>
if you're interested in the math or the algorithm we used to implement the
formula. Make sure to check out the project's
<a href="https://github.com/dzfrias/romberg/">GitHub repository</a> if you're interested in
the actual implementation! Or, of course, you can use the calculator on the
<a href="https://dzfrias.github.io/romberg/">website</a>. Lastly, if you had any questions
or comments about this post, please
<a href="https://github.com/dzfrias/website/issues/new">submit an issue</a> on this blog's
GitHub repository!</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Basically, it takes a number of
<a href="https://en.wikipedia.org/wiki/Riemann_sum">Riemann sums</a>, and &quot;combines&quot;
the information in them to extrapolate a better approximation. It's fast
because it takes calculations you've already made and produces a better one. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>It does this <em>much</em> faster than a graphing calculator can. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>If you don't, I'd recommend reading about it in
<a href="https://doc.rust-lang.org/stable/book/ch09-02-recoverable-errors-with-result.html">the Rust book</a>! <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>


      </main>
    </div>
    <div id="main-right">
      
      
    </div>
  </body>
</html>
