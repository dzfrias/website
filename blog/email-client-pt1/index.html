<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="A mini dive into the workings of the IMAP email protocol and the procedures of an email client.">
    <meta name="author" content="Diego Frias">
    <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <title>So how does email actually work? - dzfrias</title>
    
<script type="module" src="/js/index.js"></script>
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f0f0f">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300..900&display=swap">/* hebrew */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Ll4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0307-0308, U+0590-05FF, U+200C-2010, U+20AA, U+25CC, U+FB1D-FB4F;
}
/* latin-ext */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW77l4brkiY-xBg.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Frank Ruhl Libre';
  font-style: normal;
  font-weight: 300 900;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/frankruhllibre/v21/j8_w6_fAw7jrcalD7oKYNX0QfAnPW7Dl4brkiY8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>
  </head>
  <body>
    
<div aria-hidden="true" class="progress-bar"><div class="progress-bar-inner"></div></div>

    <div id="main-left">
      
<nav class="toc">
        <ol><li><a href="#the-basics">The Basics</a><ol><li><a href="#connecting">Connecting</a></li><li><a href="#getting-information">Getting Information</a><ol><li><a href="#logging-in">Logging In</a></li><li><a href="#retrieving-emails">Retrieving Emails</a></li></ol></li></ol></li><li><a href="#summary">Summary</a></li><li><a href="#references">References</a></li></ol>
      </nav>

    </div>
    <div id="main-content">
      <header>
        <nav>
          <a href="/" aria-label="Home">
            <div class="header-logo">
              <svg class="profile" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_2)">
<rect width="200" height="200" fill="#7B7B7B"></rect>
<path d="M-50 -50L245 245L-50 240.719V-50Z" fill="#040404"></path>
<path d="M98.45 34.8C106.25 34.2 110.1 33.9 110 33.9C110.9 33.9 111.5 34.25 111.8 34.95C111.9 35.35 108.3 50.25 101 79.65L89.6 125.25C89.4 127.55 89.4 129.4 89.6 130.8C89.8 131.3 90.1 131.7 90.5 132C90.8 132.3 91.25 132.45 91.85 132.45C92.55 132.45 93.1 132.35 93.5 132.15C95.4 130.75 97.35 126.2 99.35 118.5C99.85 116.6 100.25 115.55 100.55 115.35C100.75 115.15 101.95 115.05 104.15 115.05C106.35 115.05 107.6 115.15 107.9 115.35C108.1 115.55 108.2 115.95 108.2 116.55C108.2 117.15 107.95 118.35 107.45 120.15C103.75 132.75 98.5 139.25 91.7 139.65C86.6 139.95 82.5 138.2 79.4 134.4C78.9 133.8 78.45 133.15 78.05 132.45C77.85 131.85 77.7 131.55 77.6 131.55L76.55 132.45C73.05 135.55 69.6 137.6 66.2 138.6C59.7 140.8 53.85 139.8 48.65 135.6C48.05 135.1 47.5 134.55 47 133.95C45.5 132.45 44.25 130.65 43.25 128.55C40.75 123.45 39.95 117.4 40.85 110.4C42.45 99 47.3 89.4 55.4 81.6C60.6 76.6 66.25 73.45 72.35 72.15C73.25 71.95 74.65 71.85 76.55 71.85C79.05 71.85 81.2 72.25 83 73.05C84.4 73.75 85.7 74.7 86.9 75.9C87.7 76.7 88.1 77 88.1 76.8C88.2 76.7 89.45 71.9 91.85 62.4C94.15 53.1 95.35 47.9 95.45 46.8C95.45 45.9 95.35 45.35 95.15 45.15C94.45 44.45 92.3 44.05 88.7 43.95C86.3 43.95 84.9 43.6 84.5 42.9L84.35 42.45L85.1 39.45C85.5 37.55 85.9 36.4 86.3 36C86.6 35.7 86.9 35.55 87.2 35.55L98.45 34.8ZM77.15 78.9C73.05 78.2 69.1 80.15 65.3 84.75C64.3 86.05 63.4 87.45 62.6 88.95C61.1 91.85 59.3 97.55 57.2 106.05C55.9 110.85 54.95 115.05 54.35 118.65C53.95 122.05 53.95 124.65 54.35 126.45C55.35 129.95 57.3 131.95 60.2 132.45C61.9 132.75 63.95 132.4 66.35 131.4C69.95 129.4 73.35 126.05 76.55 121.35L77.3 120.3L81.05 105.3L84.8 90.3L84.5 89.25C83.6 83.55 81.4 80.15 77.9 79.05C77.7 78.95 77.45 78.9 77.15 78.9ZM154.811 32.4C155.311 32.3 156.311 32.25 157.811 32.25C160.111 32.35 162.211 32.9 164.111 33.9C168.011 35.9 169.961 39.1 169.961 43.5C169.961 45.3 169.561 47 168.761 48.6C168.361 49.6 167.761 50.45 166.961 51.15C165.961 52.15 165.111 52.8 164.411 53.1C161.611 54.4 158.961 54.45 156.461 53.25C153.961 51.95 153.061 49.65 153.761 46.35C153.861 45.95 153.961 45.55 154.061 45.15C154.761 42.85 156.011 41.15 157.811 40.05C158.311 39.75 157.961 39.5 156.761 39.3C156.061 39.3 155.561 39.4 155.261 39.6C154.461 40.2 153.911 40.9 153.611 41.7C153.211 42.5 152.161 47.1 150.461 55.5C148.161 66.5 147.011 72.4 147.011 73.2C147.011 73.3 149.711 73.35 155.111 73.35H163.211L163.811 73.8C164.211 74.3 164.161 75.65 163.661 77.85C163.161 80.05 162.711 81.25 162.311 81.45C162.011 81.65 159.111 81.75 153.611 81.75C148.111 81.75 145.361 81.85 145.361 82.05L141.461 101.85L136.961 125.1C134.261 138.1 131.661 147.4 129.161 153C125.961 160.4 121.861 165.25 116.861 167.55C115.461 168.25 113.961 168.65 112.361 168.75C107.961 168.95 104.461 167.6 101.861 164.7C101.661 164.6 101.511 164.45 101.411 164.25C100.011 162.25 99.3113 160.05 99.3113 157.65C99.3113 155.75 99.7113 154 100.511 152.4C100.911 151.4 101.511 150.55 102.311 149.85C103.311 148.85 104.161 148.2 104.861 147.9C107.661 146.6 110.311 146.55 112.811 147.75C115.311 149.05 116.211 151.35 115.511 154.65C115.411 155.05 115.311 155.45 115.211 155.85C114.511 158.15 113.261 159.85 111.461 160.95C110.861 161.35 111.211 161.55 112.511 161.55C113.311 161.55 113.911 161.4 114.311 161.1C115.611 160.1 116.611 157.5 117.311 153.3C118.311 147 119.811 139.9 121.811 132L124.811 118.5C129.511 93.4 131.861 81.2 131.861 81.9C131.861 81.8 129.561 81.75 124.961 81.75C120.061 81.75 117.411 81.4 117.011 80.7C116.811 80.4 116.961 79.25 117.461 77.25C117.961 75.25 118.361 74.1 118.661 73.8L119.111 73.35H126.311H133.511V73.05L135.011 65.7C137.011 55.3 138.961 48.05 140.861 43.95C143.961 37.65 148.611 33.8 154.811 32.4Z" fill="white"></path>
</g>
<defs>
<clipPath id="clip0_1_2">
<rect width="200" height="200" fill="white"></rect>
</clipPath>
</defs>
</svg>

            </div>
          </a>
          <ul>
            
            <li>
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
              <a href="/projects/">Projects</a>
            </li>
            
            <li>
              <a href="https://github.com/dzfrias">GitHub</a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main tabindex="-1">
        
<h1>So how does email actually work?</h1>
<p>In this post, I'm going to explore one of the fundamental technologies of the
Internet: <strong>email</strong>. Personally, I've always wondered how email clients work,
but I never knew where to start.</p>
<p>There's a lot to unpack:</p>
<ul>
<li>How do you manage multiple email accounts?</li>
<li><em>What</em> is actually receiving the mail?</li>
<li>How do all email clients receive the same information?</li>
<li>How does sending mail work?</li>
</ul>
<p>In this post, I'll be answering some of those questions. No experience with
network programming or anything related is required!</p>
<h2 id="the-basics" tabindex="-1"><a class="header-anchor" href="#the-basics">The Basics</a></h2>
<p>I'm going to start from the beginning: you receive an email.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> The first
thing to find out is <em>what</em> received it, and where.</p>
<p>Let's say your email address is <code>hello@icloud.com</code>. The <code>@icloud.com</code> means it's
managed by iCloud Mail. iCloud Mail is what's called an <strong>email server</strong>. It
holds all the emails of <strong>all</strong> <code>@icloud.com</code> email addresses. It's this server
that contains the email that was sent to <code>hello@icloud.com</code> (and literally
everyone else's)!<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup></p>
<h3 id="connecting" tabindex="-1"><a class="header-anchor" href="#connecting">Connecting</a></h3>
<p>So now we know that our email is stored on a remote server that iCloud Mail sets
up. Like pretty much everything else, this server conforms to the
<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP protocol</a>, so
we should be able to connect to it remotely. I'll show how to do so using
<a href="https://en.wikipedia.org/wiki/OpenSSL">OpenSSL</a> and the command line.<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup></p>
<pre class="language-bash"><code class="language-bash">$ openssl s_client <span class="token parameter variable">-connect</span> imap.mail.me.com:993
<span class="token comment"># A bunch of output telling us that the connection was successful (hopefully)</span></code></pre>
<p>We're telling OpenSSL that we want to connect to the TCP server located at
<code>imap.mail.me.com:993</code>. This is the standard TCP/IP address that iCloud Mail
uses (it is not specific to me, in some way). That is, every <strong>email client</strong>
that wants to get email data from an iCloud account uses this TCP/IP address.</p>
<blockquote>
<p>Different email servers, like Gmail, have different TCP/IP addresses to
connect to. For example, Gmail uses <code>imap.gmail.com:993</code>.</p>
</blockquote>
<h3 id="getting-information" tabindex="-1"><a class="header-anchor" href="#getting-information">Getting Information</a></h3>
<p>Ok, so now we're connected to the email server. We need to send it messages to
request information about our emails. The question becomes: how? They key lies
in the TCP/IP address: <code>imap.mail.me.com:993</code>. The magic word is <strong>IMAP</strong>!</p>
<p>IMAP is a <strong>protocol</strong> that tells us two things:<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup></p>
<ol>
<li>How to structure the messages to get the information we want</li>
<li>What the response will look like</li>
</ol>
<p>Using our OpenSSL client, we can compose messages by typing in some stuff, and
we can press enter to send it.<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> But you'll likely get a response back
telling you that the message you sent was malformed in some way. That's because
it didn't conform to the IMAP protocol! Let's look at some messages that <em>do</em>
conform to the protocol.</p>
<h4 id="logging-in" tabindex="-1"><a class="header-anchor" href="#logging-in">Logging In</a></h4>
<p>In order to access any data, we need to log in to our email account to make sure
the email server knows who we are. The IMAP protocol tells us how to compose a
message so that the server knows that we want to log in:</p>
<pre class="language-text"><code class="language-text">C: a1 LOGIN {email} {password}
a1 OK user {email} logged in</code></pre>
<p>Here I'm using <code>C</code> to denote the client message (so if you're trying this at
home, omit the <code>C:</code>), and lines without <code>C</code> to denote server output.</p>
<p>If we send <strong>that</strong> message (substituting in our actual email and password),
we'll be logged in and should be able to access our emails by sending more
IMAP-compliant messages.</p>
<blockquote>
<p>If you want to try this at home using your own iCloud email account, your
password <em>will not</em> be your iCloud account password. You'll need to create an
<a href="https://support.apple.com/en-us/102654">app-specific password</a> and enter that
in the message.</p>
<p>Every email server has their own way to do passwords/authentication (I'm not
using Gmail for this example because Google's authentication is enormously
complicated for a blog post).</p>
</blockquote>
<h4 id="retrieving-emails" tabindex="-1"><a class="header-anchor" href="#retrieving-emails">Retrieving Emails</a></h4>
<p>Now we're ready to look at some messages. The first thing we need to do is
select a <strong>folder</strong>. An IMAP folder contains emails. Examples of common folders
are:</p>
<ul>
<li>INBOX</li>
<li>Trash</li>
<li>Spam</li>
<li>Drafts</li>
</ul>
<p>This is how you select a folder:</p>
<pre class="language-text"><code class="language-text">C: g21 SELECT INBOX
* 1 EXISTS
* 0 RECENT
* OK [UNSEEN 1]
* OK [UIDVALIDITY 1451405933]
* OK [UIDNEXT 2272]
* FLAGS (\Answered \Flagged \Draft \Deleted \Seen \Recent $MailFlagBit0 $MailFlagBit1 $MailFlagBit2 $Forwarded Redirected $NotJunk NotJunk)
* OK [PERMANENTFLAGS (\Answered \Flagged \Draft \Deleted \Seen \Recent $MailFlagBit0 $MailFlagBit1 $MailFlagBit2 $Forwarded Redirected $NotJunk NotJunk \*)]
g21 OK [READ-WRITE] SELECT completed (took 2 ms)</code></pre>
<p>The main output we're looking for is the first line. It tells us that there's
one email in our INBOX folder. Let's take a look at this email:</p>
<pre class="language-plain"><code class="language-plain">C: f1 FETCH 1 RFC822.TEXT
* 1 FETCH (RFC822.TEXT {242}
--00000000000055129906262bbfde
Content-Type: text/plain; charset="UTF-8"

Hello, world!

--00000000000055129906262bbfde
Content-Type: text/html; charset="UTF-8"

&lt;div dir="ltr">Hello, world!&lt;/div>

--00000000000055129906262bbfde--
)
f1 OK FETCH completed (took 153 ms)</code></pre>
<p>Note that the output comes in two different forms: HTML and plain text.</p>
<p>The <code>FETCH</code> command is very versatile; it's the primary tool email clients use
to retrieve the contents of your emails.</p>
<h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary">Summary</a></h2>
<p>Here are they key takeaways from our exploration of email:</p>
<ul>
<li>The <strong>domain</strong> part of an email designates a remote server to manage that
account</li>
<li>An email client connects to email servers to retrieve information using a
protocol</li>
<li>The most widely used protocol for email servers is IMAP</li>
</ul>
<p>In future posts, I'll take a dive into <em>sending</em> emails using the
<a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">SMTP protocol</a>. I
hope you enjoyed this post! If you found any problems or have any suggestions,
make sure to open an issue on this
<a href="https://github.com/dzfrias/website/issues/new">website's GitHub repository</a>.</p>
<h2 id="references" tabindex="-1"><a class="header-anchor" href="#references">References</a></h2>
<ol>
<li><a href="https://www.ietf.org/rfc/rfc9051.html">IMAP Specification</a></li>
<li><a href="https://en.wikipedia.org/wiki/Email_client">Wikipedia</a></li>
<li><a href="https://support.apple.com/en-us/102525">Apple Support</a></li>
<li><a href="https://www.atmail.com/blog/advanced-imap/">atmail</a></li>
</ol>
<p>I recommend reading through some of these sources to get a more thorough
understanding of the concepts in this blog post.</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>You might be thinking: “what? That's not the beginning! What about the
person who <em>sent</em> the email?” Yes, you're right. But I'm just going to
accept that the magical Internet wire electricity stuff happens, and the
email is successfully sent <em>somewhere</em>. For now. An explanation of sending
an email might come in a future post. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>This is a bit of an oversimplification, since iCloud Mail definitely isn't
just <em>one single</em> computer that has all the <code>@icloud.com</code> emails in the
world. But we can conceptually and practically treat it like this is the
case, because the implementation of the server is abstracted from us. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><code>nc</code> (or <a href="https://en.wikipedia.org/wiki/Netcat">netcat</a>) is another command
line tool you may have heard of for connecting to remote TCP servers. iCloud
Mail uses <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS/SSL</a>
encryption on top of TCP, though, so it's easiest to use <code>openssl</code> to
connect. <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>There are other protocols email servers use.
<a href="https://en.wikipedia.org/wiki/Post_Office_Protocol">POP</a> is another common
one, albeit less present today. Most email servers communicate using IMAP. <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>Remember: the OpenSSL command line tool isn't the <em>only</em> way to communicate
with the server. Your favorite programming language likely has a way to do
it, too. <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>


      </main>
    </div>
    <div id="main-right">
      
      
    </div>
  </body>
</html>
