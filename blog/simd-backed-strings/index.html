<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="A report on my creation of SIMD-backed strings, an extremely fast small string type with SIMD built-in.">
    <meta name="author" content="Diego Frias">
    <meta name="robots" content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">
    <title>Exploring SIMD-Backed Strings - dzfrias</title>
    

<script type="module">
  const e=document.getElementsByClassName("expand-img");for(let t of e){const e=t.children[0],n=t.children[1];e.addEventListener("click",(()=>n.showModal())),n.addEventListener("click",(e=>{const t=e.target.getBoundingClientRect();t.top<=e.clientY&&e.clientY<=t.top+t.height&&t.left<=e.clientX&&e.clientX<=t.left+t.width||n.close()}))}const t=new Map;!function e(n){for(const o of n.children)switch(o.tagName){case"OL":e(o);break;case"LI":const n=o.firstElementChild;t.set(n.href,n);for(let t=1;t<o.children.length;t++){e(o.children[t])}}}(document.getElementsByClassName("toc")[0].firstElementChild);const n=Array.from(document.getElementsByClassName("header-anchor"));n.sort(((e,t)=>e.getBoundingClientRect().y-t.getBoundingClientRect().y));let o=0,s=!1,i=null;document.addEventListener("scroll",(()=>{o=window.scrollY,s||(window.requestAnimationFrame((()=>{i&&(i.ariaCurrent="false");const e=Array.from(n).sort(((e,t)=>{const n=e.getBoundingClientRect().top,o=t.getBoundingClientRect().top;return Math.abs(n)-Math.abs(o)}))[0];t.get(e.href).ariaCurrent="location",i=t.get(e.href),s=!1})),s=!0)}));for(const e of document.getElementsByClassName("progress-bar")){const t=e.firstElementChild;document.addEventListener("scroll",(()=>{const e=window.scrollY/(document.body.offsetHeight-window.innerHeight);t.style.width=100*e+"%"}))}const l=document.querySelectorAll('a[id^="fnref"]'),r=document.getElementsByClassName("footnote-item"),c=document.getElementById("main-right");for(let e=0;e<l.length;e++){const t=l[e],n=r[e].children[0].cloneNode(!0);let o;t.addEventListener("mouseover",(()=>{o=document.createElement("aside"),c.appendChild(o),o.classList.add("footnote-preview"),o.appendChild(n),o.style.position="absolute",o.style.top=t.getBoundingClientRect().top+window.scrollY+"px",o.style.opacity="100%"})),t.addEventListener("mouseleave",(()=>{o.style.opacity="0%",o.addEventListener("transitionend",(()=>o.remove()))}))}function a(){const e=location.hash.slice(1);if(!e.startsWith("fn")||e.startsWith("fnref")){for(const e of r)e.ariaCurrent=null;return}for(const e of r)e.ariaCurrent="false";document.getElementById(e).ariaCurrent="true"}a(),window.onhashchange=a;
</script>
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"></noscript>

    <link rel="stylesheet" href="/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f0f0f">
    <link rel="preload" href="/fonts/font.woff2" as="font" type="font/woff2" crossorigin="">
    <meta name="theme-color" content="#0f0f0f">
  </head>
  <body>
    
<div aria-hidden="true" class="progress-bar"><div class="progress-bar-inner"></div></div>

    <div id="main-left">
      
<aside class="toc-container">
  <nav class="toc">
        <ol><li><a href="#what-is-a-simd-backed-string%3F">What is a SIMD-Backed String?</a><ol><li><a href="#example">Example</a></li></ol></li><li><a href="#implementation">Implementation</a></li><li><a href="#benchmarks">Benchmarks</a></li><li><a href="#wrap-up">Wrap-Up</a></li></ol>
      </nav>
</aside>

    </div>
    <div id="main-content">
      <header>
        <nav>
          <a href="/" aria-label="Home">
            <div class="header-logo">
              <svg class="profile" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_1_2)">
<rect width="200" height="200" fill="#7B7B7B"></rect>
<path d="M-50 -50L245 245L-50 240.719V-50Z" fill="#040404"></path>
<path d="M98.45 34.8C106.25 34.2 110.1 33.9 110 33.9C110.9 33.9 111.5 34.25 111.8 34.95C111.9 35.35 108.3 50.25 101 79.65L89.6 125.25C89.4 127.55 89.4 129.4 89.6 130.8C89.8 131.3 90.1 131.7 90.5 132C90.8 132.3 91.25 132.45 91.85 132.45C92.55 132.45 93.1 132.35 93.5 132.15C95.4 130.75 97.35 126.2 99.35 118.5C99.85 116.6 100.25 115.55 100.55 115.35C100.75 115.15 101.95 115.05 104.15 115.05C106.35 115.05 107.6 115.15 107.9 115.35C108.1 115.55 108.2 115.95 108.2 116.55C108.2 117.15 107.95 118.35 107.45 120.15C103.75 132.75 98.5 139.25 91.7 139.65C86.6 139.95 82.5 138.2 79.4 134.4C78.9 133.8 78.45 133.15 78.05 132.45C77.85 131.85 77.7 131.55 77.6 131.55L76.55 132.45C73.05 135.55 69.6 137.6 66.2 138.6C59.7 140.8 53.85 139.8 48.65 135.6C48.05 135.1 47.5 134.55 47 133.95C45.5 132.45 44.25 130.65 43.25 128.55C40.75 123.45 39.95 117.4 40.85 110.4C42.45 99 47.3 89.4 55.4 81.6C60.6 76.6 66.25 73.45 72.35 72.15C73.25 71.95 74.65 71.85 76.55 71.85C79.05 71.85 81.2 72.25 83 73.05C84.4 73.75 85.7 74.7 86.9 75.9C87.7 76.7 88.1 77 88.1 76.8C88.2 76.7 89.45 71.9 91.85 62.4C94.15 53.1 95.35 47.9 95.45 46.8C95.45 45.9 95.35 45.35 95.15 45.15C94.45 44.45 92.3 44.05 88.7 43.95C86.3 43.95 84.9 43.6 84.5 42.9L84.35 42.45L85.1 39.45C85.5 37.55 85.9 36.4 86.3 36C86.6 35.7 86.9 35.55 87.2 35.55L98.45 34.8ZM77.15 78.9C73.05 78.2 69.1 80.15 65.3 84.75C64.3 86.05 63.4 87.45 62.6 88.95C61.1 91.85 59.3 97.55 57.2 106.05C55.9 110.85 54.95 115.05 54.35 118.65C53.95 122.05 53.95 124.65 54.35 126.45C55.35 129.95 57.3 131.95 60.2 132.45C61.9 132.75 63.95 132.4 66.35 131.4C69.95 129.4 73.35 126.05 76.55 121.35L77.3 120.3L81.05 105.3L84.8 90.3L84.5 89.25C83.6 83.55 81.4 80.15 77.9 79.05C77.7 78.95 77.45 78.9 77.15 78.9ZM154.811 32.4C155.311 32.3 156.311 32.25 157.811 32.25C160.111 32.35 162.211 32.9 164.111 33.9C168.011 35.9 169.961 39.1 169.961 43.5C169.961 45.3 169.561 47 168.761 48.6C168.361 49.6 167.761 50.45 166.961 51.15C165.961 52.15 165.111 52.8 164.411 53.1C161.611 54.4 158.961 54.45 156.461 53.25C153.961 51.95 153.061 49.65 153.761 46.35C153.861 45.95 153.961 45.55 154.061 45.15C154.761 42.85 156.011 41.15 157.811 40.05C158.311 39.75 157.961 39.5 156.761 39.3C156.061 39.3 155.561 39.4 155.261 39.6C154.461 40.2 153.911 40.9 153.611 41.7C153.211 42.5 152.161 47.1 150.461 55.5C148.161 66.5 147.011 72.4 147.011 73.2C147.011 73.3 149.711 73.35 155.111 73.35H163.211L163.811 73.8C164.211 74.3 164.161 75.65 163.661 77.85C163.161 80.05 162.711 81.25 162.311 81.45C162.011 81.65 159.111 81.75 153.611 81.75C148.111 81.75 145.361 81.85 145.361 82.05L141.461 101.85L136.961 125.1C134.261 138.1 131.661 147.4 129.161 153C125.961 160.4 121.861 165.25 116.861 167.55C115.461 168.25 113.961 168.65 112.361 168.75C107.961 168.95 104.461 167.6 101.861 164.7C101.661 164.6 101.511 164.45 101.411 164.25C100.011 162.25 99.3113 160.05 99.3113 157.65C99.3113 155.75 99.7113 154 100.511 152.4C100.911 151.4 101.511 150.55 102.311 149.85C103.311 148.85 104.161 148.2 104.861 147.9C107.661 146.6 110.311 146.55 112.811 147.75C115.311 149.05 116.211 151.35 115.511 154.65C115.411 155.05 115.311 155.45 115.211 155.85C114.511 158.15 113.261 159.85 111.461 160.95C110.861 161.35 111.211 161.55 112.511 161.55C113.311 161.55 113.911 161.4 114.311 161.1C115.611 160.1 116.611 157.5 117.311 153.3C118.311 147 119.811 139.9 121.811 132L124.811 118.5C129.511 93.4 131.861 81.2 131.861 81.9C131.861 81.8 129.561 81.75 124.961 81.75C120.061 81.75 117.411 81.4 117.011 80.7C116.811 80.4 116.961 79.25 117.461 77.25C117.961 75.25 118.361 74.1 118.661 73.8L119.111 73.35H126.311H133.511V73.05L135.011 65.7C137.011 55.3 138.961 48.05 140.861 43.95C143.961 37.65 148.611 33.8 154.811 32.4Z" fill="white"></path>
</g>
<defs>
<clipPath id="clip0_1_2">
<rect width="200" height="200" fill="white"></rect>
</clipPath>
</defs>
</svg>

            </div>
          </a>
          <ul>
            
            <li>
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
              <a href="/projects/">Projects</a>
            </li>
            
            <li>
              <a href="https://github.com/dzfrias">GitHub</a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main tabindex="-1">
        
<h1>Exploring SIMD-Backed Strings</h1>
<p>Perhaps one of the most accessible uses of
<a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a> is in
string algorithms. If you're unfamiliar, SIMD instructions are CPU operations
that operate on <strong>vectors</strong> of data, as opposed to scalar registers like most
instructions. This means that you can perform operations on multiple pieces of
information, <em>simultaneously</em>. The example below shows SIMD addition, where two
vectors are added component-wise with one instruction, all at the same time.</p>
<p></p><div class="expand-img"><button aria-haspopup="dialog" aria-label="Expand image"><picture><source type="image/webp" srcset="/img/QNTtofHJ8S-1120.webp 1120w"><img loading="lazy" decoding="async" src="/img/QNTtofHJ8S-1120.jpeg" alt="an example of component-wise addition in SIMD" width="1120" height="469"></picture></button><dialog><picture><source type="image/webp" srcset="/img/QNTtofHJ8S-1120.webp 1120w"><img loading="lazy" decoding="async" src="/img/QNTtofHJ8S-1120.jpeg" alt="an example of component-wise addition in SIMD" width="1120" height="469"></picture></dialog></div><p></p>
<p>For strings, there are a lot of ways SIMD can speed up algorithms. In Rust,
there's the popular <a href="https://docs.rs/memchr/latest/memchr/">memchr crate</a> that
provides a ludicrously fast SIMD byte search, and plenty of optimized parsers
utilize SIMD.<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn1" id="fnref1">1</a></sup> SIMD string algorithms generally work like this:</p>
<ol>
<li>Convert a slice of the string to a SIMD vector</li>
<li>Execute some SIMD instructions</li>
<li>Repeat 1-2 for the whole string until the algorithm's result is computed</li>
</ol>
<p>A couple of days ago, though, I had an idea: why don't we make a string type
that's cheap to copy (small), and, using this smallness, make every algorithm
performed on it to take advantage of SIMD automatically?</p>
<h2 id="what-is-a-simd-backed-string%3F" tabindex="-1"><a class="header-anchor" href="#what-is-a-simd-backed-string%3F">What is a SIMD-Backed String?</a></h2>
<p>A SIMD-backed string is <strong>a string whose information is packed into a SIMD
vector, in totality</strong>. Many string operations (e.g. <code>find</code>, <code>contains</code>,
<code>to_uppercase</code>, etc.) can inherently be accelerated with SIMD, with no
conversions necessary!</p>
<p>Since the length of the string is <strong>always</strong> less than the length of a SIMD
vector, we can do all of our standard string operations using SIMD without any
extra work.<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn2" id="fnref2">2</a></sup> Also, since these strings are small, they'll be cheap to
copy.</p>
<p>Here's a diagram of what a SIMD string might look like in memory:</p>
<p></p><div class="expand-img"><button aria-haspopup="dialog" aria-label="Expand image"><picture><source type="image/webp" srcset="/img/qCSclQNw2H-920.webp 920w"><img loading="lazy" decoding="async" src="/img/qCSclQNw2H-920.jpeg" alt="example string, showing eight squares that contain the message: &quot;hello!!&quot;" width="920" height="141"></picture></button><dialog><picture><source type="image/webp" srcset="/img/qCSclQNw2H-920.webp 920w"><img loading="lazy" decoding="async" src="/img/qCSclQNw2H-920.jpeg" alt="example string, showing eight squares that contain the message: &quot;hello!!&quot;" width="920" height="141"></picture></dialog></div><p></p>
<p>In the above picture, each square is one byte, so the SIMD string is 8 bytes
wide <strong>maximum</strong>. This special string is also <strong>NUL terminated</strong>. For any C
programmers who just had a violent reaction upon reading that, don't worry! We
can easily (and efficiently) compute the length using SIMD operations, so the
pitfalls of NUL-terminated strings can be avoided.</p>
<h3 id="example" tabindex="-1"><a class="header-anchor" href="#example">Example</a></h3>
<p>Let's write an algorithm to convert a SIMD-string <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05764em;">S</span></span></span></span> to lowercase. In ASCII
world, you may know that for any uppercase letter <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span></span></span></span>, the corresponding
lowercase letter is <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mo>+</mo><mn>3</mn><mn>2</mn></mrow><annotation encoding="application/x-tex">l + 32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span>. We can exploit this fact: at the <em>simplest level</em>,
our algorithm will be a vector addition operation. Let's write it out:</p>
<pre class="language-nasm"><code class="language-nasm"><span class="token comment">;; simd.add DST LHS RHS</span>
<span class="token comment">;; Splat takes in a scalar and returns</span>
<span class="token comment">;; a vector filled with that scalar.</span>
simd.add S S splat(<span class="token number">32</span>)</code></pre>
<p>This performs component-wise addition on each byte in <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05764em;">S</span></span></span></span>, turning each
uppercase letter to lowercase. However, this implementation is buggy! What
happens when the character is <em>not</em> alphabetic? We need a way to conditionally
apply our addition, so that it <em>only</em> operates on uppercase letters.</p>
<p>That's where <strong>masks</strong> and <strong>selects</strong> come into play. A mask is a SIMD vector
that contains only zeroes and ones. For our use-case, we want a mask <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span> such
that <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M_i = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span> when <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn><mn>5</mn><mo>≤</mo><msub><mi>S</mi><mi>i</mi></msub><mo>≤</mo><mn>9</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">65 \le S_i \le 90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">6</span><span class="mord mathrm">5</span><span class="mrel">≤</span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">≤</span><span class="mord mathrm">9</span><span class="mord mathrm">0</span></span></span></span>, and zero otherwise (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn><mn>5</mn></mrow><annotation encoding="application/x-tex">65</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">6</span><span class="mord mathrm">5</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>9</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">9</span><span class="mord mathrm">0</span></span></span></span> are
the byte values of <code>'A'</code>and <code>'Z'</code>, respectively). In math notation:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mn>1</mn></mrow></mtd><mtd><mrow><mn>6</mn><mn>5</mn><mo>≤</mo><msub><mi>S</mi><mi>i</mi></msub><mo>≤</mo><mn>9</mn><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mn>0</mn></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">w</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">e</mi></mtext></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">M_i =
\begin{cases}
    1 &amp; 65 \le S_i \le 90 \\
    0 &amp; \text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">1</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">6</span><span class="mord mathrm">5</span><span class="mrel">≤</span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">≤</span><span class="mord mathrm">9</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm">o</span><span class="mord mathrm">t</span><span class="mord mathrm">h</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.01389em;">w</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">e</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>Then, we can use a select, which will use this mask to &quot;conditionally&quot; modify
characters in our string. Here's what the algorithm looks like with the mask and
select:</p>
<pre class="language-nasm"><code class="language-nasm"><span class="token comment">;; Two masks: one selecting values >= 65,</span>
<span class="token comment">;; the other selecting values &lt;= 90</span>
simd.ge M1 S splat(<span class="token number">65</span>)
simd.le M2 S splat(<span class="token number">90</span>)
<span class="token comment">;; Combine the masks using bitwise-and</span>
<span class="token comment">;; storing the result in M</span>
simd.and M M1 M2

<span class="token comment">;; Stored in T</span>
simd.add T S splat(<span class="token number">32</span>)
<span class="token comment">;; simd.select DST M T F</span>
simd.select S M T S</code></pre>
<p>The key here is <code>simd.select</code>. It takes in a mask, and for each <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>, when
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M_i = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span>, it sets <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext><mi mathvariant="normal">D</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">T</mi></mtext><mi>i</mi></msub><mo>=</mo><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{DST}_i = T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="text mord textstyle uncramped"><span class="mord mathrm">D</span><span class="mord mathrm">S</span><span class="mord mathrm">T</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>, and if <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">M_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span></span></span></span>, it sets
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext><mi mathvariant="normal">D</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">T</mi></mtext><mi>i</mi></msub><mo>=</mo><msub><mi>F</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{DST}_i = F_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="text mord textstyle uncramped"><span class="mord mathrm">D</span><span class="mord mathrm">S</span><span class="mord mathrm">T</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>. In other words:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext><mi mathvariant="normal">D</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">T</mi></mtext><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow></mtd><mtd><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow></mtd></mtr><mtr><mtd><mrow><msub><mi>F</mi><mi>i</mi></msub></mrow></mtd><mtd><mrow><msub><mi>M</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\text{DST}_i = \begin{cases}
                T_i &amp; M_i = 1 \\
                F_i &amp; M_i = 0
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm">D</span><span class="mord mathrm">S</span><span class="mord mathrm">T</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10903em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>Hopefully this example showed how SIMD can be used to write branchless, parallel
algorithms. And (<a href="#benchmarks">spoiler alert!</a>), this algorithm is <em>much</em> faster
than its non-SIMD counterpart.</p>
<h2 id="implementation" tabindex="-1"><a class="header-anchor" href="#implementation">Implementation</a></h2>
<p>I implemented SIMD-backed strings in <strong>Rust</strong> using the experimental
<a href="https://github.com/rust-lang/portable-simd"><code>portable-simd</code></a> feature. The
string looks like this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Qstr</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">N</span><span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">Simd</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token operator">></span><span class="token punctuation">)</span>
<span class="token keyword">where</span>
    <span class="token class-name">LaneCount</span><span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token operator">></span><span class="token punctuation">:</span> <span class="token class-name">SupportedLaneCount</span><span class="token punctuation">;</span></code></pre>
<p>This allows you to choose the size <code>N</code> at compile time.</p>
<p>I'd never used <code>portable-simd</code> before, but it was wonderful! The
<a href="#example">example algorithm</a> I gave is implemented like this:</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Qstr</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">to_lowercase</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mask <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">simd_ge</span><span class="token punctuation">(</span><span class="token class-name">Simd</span><span class="token punctuation">::</span><span class="token function">splat</span><span class="token punctuation">(</span><span class="token char">b'A'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">simd_le</span><span class="token punctuation">(</span><span class="token class-name">Simd</span><span class="token punctuation">::</span><span class="token function">splat</span><span class="token punctuation">(</span><span class="token char">b'Z'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">Self</span><span class="token punctuation">(</span>mask<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token class-name">Simd</span><span class="token punctuation">::</span><span class="token function">splat</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// --snip</span>
<span class="token punctuation">}</span></code></pre>
<p><code>portable-simd</code> has an amazing API that allows SIMD code to be concise,
intuitive, and of course, CPU-agnostic. My main only pain points were when I
needed to swizzle a vector, but the team is
<a href="https://github.com/rust-lang/portable-simd/issues/364">actively working on that</a>!
I personally cannot wait until the library is stabilized!<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn3" id="fnref3">3</a></sup></p>
<h2 id="benchmarks" tabindex="-1"><a class="header-anchor" href="#benchmarks">Benchmarks</a></h2>
<p>As far as I'm aware, SIMD-backed strings boast some of the <strong>best performance</strong>
numbers out there right now. Here is a table comparing SIMD-backed strings with
various other string types, run on my M1 MacBook Air:</p>
<table>
<thead>
<tr>
<th>Test</th>
<th>Qstr</th>
<th>String</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>uppercase</code></td>
<td>382.23ps</td>
<td>16.652ns</td>
</tr>
<tr>
<td><code>replace</code></td>
<td>741.00ps</td>
<td>27.079ns</td>
</tr>
<tr>
<td><code>contains</code></td>
<td>462.25ps</td>
<td>7.5863ns</td>
</tr>
<tr>
<td><code>find</code></td>
<td>783.67ps</td>
<td>11.436ns</td>
</tr>
<tr>
<td><code>eq</code></td>
<td>313.04ps</td>
<td>1.5928ns</td>
</tr>
</tbody>
</table>
<p>This is only a small selection of algorithms, but similar performance behavior
is present for the rest of the <code>Qstr</code> methods.<sup class="footnote-ref"><a role="doc-noteref" aria-label="go to footnote" href="#fn4" id="fnref4">4</a></sup></p>
<p>For some methods (like <code>replace</code>), the performance increase was substantial. For
others, (i.e. <code>eq</code>), the performance increase was statistically significant but
not as incredible. Also note that each of tests were run on a string with
length 16.</p>
<p>I've compiled a list of reasons why I think why such good performance is
possible:</p>
<ul>
<li>SIMD. Computations are done in a single step.</li>
<li>Small. The strings aren't heap allocated, and they're cache-efficient.</li>
<li>Branchless. Most algorithms can be done without branches.</li>
<li>Immutable. Moving it around is cheap and thus there are less pointer derefs.</li>
<li>Always in a SIMD vector. No conversions necessary!</li>
</ul>
<h2 id="wrap-up" tabindex="-1"><a class="header-anchor" href="#wrap-up">Wrap-Up</a></h2>
<p>This post was a report on some experiments I've been doing with SIMD-backed
strings. I also tried to give an introduction to SIMD and its use-cases, so
hopefully you can start applying SIMD to your programs where it's appropriate!</p>
<p>SIMD-backed strings are useful as a &quot;small string&quot; type, which is a very common
optimization for string-related programs. They use SIMD out of the box, so <em>no</em>
SIMD knowledge is required to take advantage of SIMD's speed!</p>
<p>Anyway, I hope this post was interesting and clear. If there were any issues,
errors, or questions you came across while reading, feel free to open a
<a href="https://github.com/dzfrias/website/issues/new">GitHub issue</a> in this website's
GitHub repository!</p>
<hr>
<section class="footnotes" role="doc-endnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Examples: <a href="https://github.com/simdjson/simdjson"><code>simdjson</code></a>,
<a href="https://github.com/y21/tl"><code>tl</code></a>, and
<a href="https://docs.rs/atoi_simd/latest/atoi_simd/"><code>atoi-simd</code></a>. <a role="doc-backlink" aria-label="back to text" href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>The largest SIMD vectors I could find on commercial CPUs are 512-bits wide,
but most machines support a maximum of 256-bit vectors. <a role="doc-backlink" aria-label="back to text" href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>Right now, you need the nightly version of Rust to use it. <a role="doc-backlink" aria-label="back to text" href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>Note that <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span> <code>String</code> operations like <code>contains</code>, <code>find</code>, and <code>eq</code> were
done with <strong>worst-case</strong> scenarios. There were no notable worst-case
scenarios for <code>Qstr</code> algorithms. <a role="doc-backlink" aria-label="back to text" href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
</ol></section>

      </main>
    </div>
    <div id="main-right">
      
      
    </div>
  </body>
</html>
